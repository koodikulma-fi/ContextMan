var t,e=(t,e,s,n)=>new(s||(s=Promise))(((i,r)=>{function o(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((t=>{t(e)}))).then(o,a)}l((n=n.apply(t,e||[])).next())}));function s(e,s){for(const n of e.slice()){const i=n[2]||0;if(i&t.OneShot){const t=n[4]||e,s=t.indexOf(n);-1!==s&&t.splice(s,1)}i&t.Deferred?setTimeout((()=>n[0](...n[1]&&s?[...s,...n[1]]:s||n[1]||[])),0):n[0](...n[1]&&s?[...s,...n[1]]:s||n[1]||[])}}function n(e,s,n){const i=n&&(n.includes('first')||n.includes('first-true')),r=n&&(i||n.includes('last')),o=n&&n.includes('no-false'),a=n&&n.includes('no-null');let l=[];for(const c of e.slice()){const h=c[2]||0;if(h&t.OneShot){const t=c[4]||e,s=t.indexOf(c);-1!==s&&t.splice(s,1)}if(h&t.Deferred)setTimeout((()=>c[0](...c[1]&&s?[...s,...c[1]]:s||c[1]||[])),0);else{const t=c[0](...c[1]&&s?[...s,...c[1]]:s||c[1]||[]);if(!t&&(void 0===t||o||a&&null==t))continue;if(r?l[0]=t:l.push(t),i&&(t||!n.includes('first-true')))break}}return r?l[0]:l}function i(e){return class extends e{constructor(...t){super(...t),this.signals={}}listenTo(e,s,n,i=t.None,r){let o=this.signals[e];const a=[s,n||null,i||t.None,null!=r?r:null];o?o.some(((t,e)=>t[0]===s&&(o[e]=a)))||o.push(a):this.signals[e]=o=[a],a[2]&t.OneShot&&a.push(o),this.onListener&&this.onListener(e,o.indexOf(a),!0)}unlistenTo(t,e,s){null==t?t=Object.keys(this.signals):'string'==typeof t&&(t=[t]);const n=null!=s;for(const i of t){const t=this.signals[i];if(t){for(let r=t.length-1;r>=0;r--)e&&t[r][0]!==e||n&&t[r][3]!==s||(this.onListener&&this.onListener(i,r,!1),t.splice(r,1));t[0]||delete this.signals[i]}}}isListening(t,e,s){return null==t?Object.keys(this.signals).some((t=>this.isListening(t,e,s))):!!this.signals[t]&&(!(e&&!this.signals[t].some((t=>t[0]===e)))&&!(null!=s&&!this.signals[t].some((t=>t[3]===s))))}}}function r(t){return class extends(i(t)){sendSignal(t,...e){const n=this.getListenersFor?this.getListenersFor(t):this.signals[t];n&&s(n,e)}sendSignalAs(t,i,...r){const o='string'==typeof t?[t]:t,a=o.includes('delay')||o.includes('pre-delay'),l=o.includes('first')||o.includes('first-true'),c=o.includes('multi')||!l&&!o.includes('last');if(o.includes('await'))return new Promise((t=>e(this,void 0,void 0,(function*(){a&&(yield this.afterRefresh(o.includes('delay')));const e=this.getListenersFor?this.getListenersFor(i):this.signals[i];if(!e)return t(c?[]:void 0);let s=(yield Promise.all(n(e,r))).filter((t=>!(void 0===t||null==t&&o.includes('no-null')||!t&&o.includes('no-false'))));l&&o.includes('first-true')&&(s=s.filter((t=>t)));const h=s.length;h?l?t(c?[s[0]]:s[0]):o.includes('last')?t(c?[s[h-1]]:s[h-1]):t(s):t(c?[]:void 0)}))));if(!a){const t=this.getListenersFor?this.getListenersFor(i):this.signals[i];return t?n(t,r,o):o.includes('last')||l?void 0:[]}(()=>{e(this,void 0,void 0,(function*(){yield this.afterRefresh(o.includes('delay'));const t=this.getListenersFor?this.getListenersFor(i):this.signals[i];t&&(l?n(t,r,o):s(t,r))}))})()}afterRefresh(t=!1){return new Promise((e=>setTimeout(e,t?1:0)))}}}(t=>{t[t.OneShot=1]='OneShot',t[t.Deferred=2]='Deferred',t[t.None=0]='None',t[t.All=3]='All'})(t||(t={}));const o=r;class a extends(i(Object)){}class l extends(r(Object)){}function c(t){return class extends t{constructor(t,...e){super(...e),this.dataListeners=new Map,this.dataKeysPending=null,this.data=t}listenToData(...t){let e=1;const s=t.length,n='boolean'==typeof t[s-e]&&t[s-e++],i=t[s-e],r=t.slice(0,s-e);this.dataListeners.set(i,r),n&&i(...r.map((t=>this.getInData(t))))}unlistenToData(t){return!!this.dataListeners.has(t)&&(this.dataListeners.delete(t),!0)}getData(){return this.data}getInData(t,e){if(!this.data)return e;if(!t)return this.data;const s=t.split('.');let n=this.data;for(const t of s){if(!n)return e;n=n[t]}return void 0===n?e:n}setData(t,e=!1,s=!0,...n){this.data=e&&this.data?Object.assign(Object.assign({},this.data),t):t,s?this.refreshData(!0,...n):this.addRefreshKeys(!0)}setInData(t,e,s=!1,n=!0,...i){if(this.data){if(t){const n=t.split('.'),i=n.pop();if(!i)return;let r=this.data;for(const t of n)r=r[t]||(r[t]={});if(s){const t=r[i];t&&t.constructor===Object?r[i]=Object.assign(Object.assign({},t),e):s=!1}s||(r[i]=e)}else this.data=s&&this.data?Object.assign(Object.assign({},this.data),e):e;n?this.refreshData(t||!0,...i):this.addRefreshKeys(t||!0)}}refreshData(t,e){if(t&&this.addRefreshKeys(t),null!=e)return void setTimeout((()=>this.refreshData(null)),e);const s=this.dataKeysPending;if(this.dataKeysPending=null,s)for(const[t,e]of this.dataListeners.entries())(!0===s||s.some((t=>e.some((e=>e===t||e.startsWith(t+'.')||t.startsWith(e+'.'))))))&&t(...e.map((t=>this.getInData(t))))}addRefreshKeys(t){if(!0===t)this.dataKeysPending=!0;else if(t&&!0!==this.dataKeysPending)if('string'==typeof t&&(t=[t]),this.dataKeysPending)for(const e of t)this.dataKeysPending.some((t=>t===e||e.startsWith(t+'.')))||this.dataKeysPending.push(e);else this.dataKeysPending=[...t]}}}const h=c;class f extends(c(Object)){}function d(t){return class extends(c(r(t))){}}const u=d;class g extends(d(Object)){}var y=(t,e,s,n)=>new(s||(s=Promise))(((i,r)=>{function o(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((t=>{t(e)}))).then(o,a)}l((n=n.apply(t,e||[])).next())}));function x(t,e,s,n,i){null!==s&&void 0!==i&&(clearTimeout(s),s=null);const r=void 0===i?n:i;return null===r?e.call(t):null===s&&(s=setTimeout((()=>e.call(t)),r)),s}class p extends g{constructor(t,e){super(t),this.contextAPIs=new Map,this.settings=p.getDefaultSettings(),this.refreshTimer=null,this._Signals=void 0,delete this._Signals,e&&this.modifySettings(e)}getListenersFor(t){let e=this.signals[t]||[];for(const[s,n]of this.contextAPIs)for(const i of n){const n=s.getListenersFor?s.getListenersFor(i,t):s.signals[i+'.'+t];n&&(e=e.concat(n))}return e[0]&&e}afterRefresh(t=!1,e){return new Promise((s=>y(this,void 0,void 0,(function*(){const n=t?'_afterRender':'_afterUpdate';this[n]||(this[n]=[]),this[n].push((()=>s())),this.triggerRefresh(e)}))))}refreshData(t,e){t&&this.addRefreshKeys(t),this.triggerRefresh(e)}triggerRefresh(t){this.refreshTimer=x(this,this.refreshPending,this.refreshTimer,this.settings.refreshTimeout,t)}refreshPending(){const t=this.dataKeysPending;let e=this._afterUpdate,s=this._afterRender;if(this.refreshTimer=null,this.dataKeysPending=null,delete this._afterUpdate,delete this._afterRender,e)for(const t of e)t();if(t){for(const[e,s]of this.dataListeners.entries())(!0===t||t.some((t=>s.some((e=>e===t||e.startsWith(t+'.')||t.startsWith(e+'.'))))))&&e(...s.map((t=>this.getInData(t))));for(const[e,s]of this.contextAPIs.entries())e.callDataListenersFor?e.callDataListenersFor(s,t):e.callDataBy(!0===t?s:s.map((e=>t.map((t=>e+'.'+t)))).reduce(((t,e)=>t.concat(e))))}s&&(()=>{y(this,void 0,void 0,(function*(){const t=[];for(const e of this.contextAPIs.keys())t.push(e.afterRefresh(!0));yield Promise.all(t);for(const t of s)t()}))})()}modifySettings(t){const e=p.getDefaultSettings();for(const s in t)t[s]=void 0===t[s]?e[s]:t[s]}static getDefaultSettings(){return{refreshTimeout:0}}}const v=(t,e)=>new p(t,e),D=(t,e)=>{const s={};for(const n in t)s[n]=v(t[n],e);return s};var m=(t,e,s,n)=>new(s||(s=Promise))(((i,r)=>{function o(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((t=>{t(e)}))).then(o,a)}l((n=n.apply(t,e||[])).next())}));function L(t){if(t.constructor===Object)return t;const e={};for(const s of t)e[s]=!0;return e}class P extends a{constructor(t){super(),this.contexts=Object.assign({},t),this.dataListeners=new Map}afterRefresh(t=!1,e){return new Promise((t=>m(this,void 0,void 0,(function*(){return t()}))))}sendSignal(t,...e){var s;const[n,i]=t.split('.',2);return null===(s=this.getContext(n))||void 0===s?void 0:s.sendSignal(i,...e)}sendSignalAs(t,e,...s){const[n,i]=e.split('.',2),r=this.getContext(n);if(r)return r.sendSignalAs(t,i,...s);const o='string'==typeof t?[t]:t,a=o.includes('last')||o.includes('first')||o.includes('first-true')?void 0:[];return o.includes('await')?new Promise((t=>t(a))):a}listenToData(...t){let e=1;const s=t.length,n='boolean'==typeof t[s-e]&&t[s-e++],i=Array.isArray(t[s-e])&&t[s-e++]||void 0,r=t[s-e],o=t.slice(0,s-e);this.dataListeners.set(r,[o,i]),n&&r(...this.getDataArgsBy(o,i))}unlistenToData(t){return!this.dataListeners.has(t)&&(this.dataListeners.delete(t),!0)}getInData(t,e=void 0){const s=t.split('.',1)[0],n=this.getContext(s);return n?n.getInData(t.slice(s.length+1),e):e}setInData(t,e,s,n,i){var r;const o=t.split('.',1)[0];null===(r=this.getContext(o))||void 0===r||r.setInData(t.slice(o.length+1),e,s,n,i)}refreshData(t,e){var s,n;const i={};for(const e of'string'==typeof t?[t]:t){const t=e.split('.',1)[0];void 0!==i[t]&&(i[t]=this.getContext(t)),null===(s=i[t])||void 0===s||s.addRefreshKeys(e.slice(t.length+1))}for(const t in i)null===(n=i[t])||void 0===n||n.refreshData(null,e)}refreshDataBy(t,e){const s=this.getContexts(t);for(const n in s){const i=s[n];i&&i.refreshData(t[n],e)}}getContext(t){return this.contexts[t]}getContexts(t){if(!t)return Object.assign({},this.contexts);const e=L(t),s={};for(const t in this.contexts)e[t]&&(s[t]=this.contexts[t]);return s}newContext(t,e,s=!0){const n=v(t);return e&&this.setContext(e,n,s),n}newContexts(t,e=!1,s=!0){const n=D(t);return e&&this.setContexts(n,s),n}setContext(t,e,s=!0){const n=this.contexts[t];if(n===e)return!1;if(n){const e=n.contextAPIs.get(this);if(e){const s=e.filter((e=>e!==t));s.length?n.contextAPIs.set(this,s):n.contextAPIs.delete(this)}}if(e){const s=e.contextAPIs.get(this)||[];s.includes(t)||s.push(t),e.contextAPIs.set(this,s)}return void 0!==e?this.contexts[t]=e:delete this.contexts[t],s&&(this.callDataListenersFor?this.callDataListenersFor([t]):this.callDataBy([t])),!0}setContexts(t,e=!0){let s=!1;for(const e in t)s=this.setContext(e,t[e],!1)||s;return e&&s&&(this.callDataListenersFor?this.callDataListenersFor(Object.keys(t)):this.callDataBy(Object.keys(t))),s}getDataArgsBy(t,e){return t.map(((t,s)=>{const n=t.split('.',1)[0],i=this.getContext(n);return i?i.getInData(t.slice(n.length+1),e&&e[s]):e&&e[s]}))}callDataBy(t=!0){for(const[e,[s,n]]of this.dataListeners.entries())(!0===t||t.some((t=>s.some((e=>e===t||e.startsWith(t+'.')||t.startsWith(e+'.'))))))&&e(...this.getDataArgsBy(s,n))}}export{p as Context,P as ContextAPI,f as DataMan,h as DataManMixin,g as DataSignalMan,u as DataSignalManMixin,a as SignalBoy,l as SignalMan,t as SignalManFlags,o as SignalManMixin,c as _DataManMixin,d as _DataSignalManMixin,i as _SignalBoyMixin,r as _SignalManMixin,n as askListeners,L as buildRecordable,s as callListeners,x as callWithTimeout,v as newContext,D as newContexts};
