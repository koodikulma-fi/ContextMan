function t(t,e){return e?'number'==typeof t?t<0?Math.max(0,t+e):Math.min(t,e-1):e-1:-1}function e(t,e,s){return null!=s?null==t?e.findIndex((t=>t[s]<0)):t<0?e.findIndex((e=>null!=e[s]&&e[s]<0&&e[s]>t)):e.findIndex((e=>null==e[s]||e[s]<0||e[s]>t)):null==t?e.findIndex((t=>t<0)):t<0?e.findIndex((e=>null!=e&&e<0&&e>t)):e.findIndex((e=>null==e||e<0||e>t))}function s(t,s){const n=[],i='string'==typeof s;for(let r=0,o=t.length;r<o;r++){const o=i?t[r][s]:s[r],a=e(o,n,0);-1===a?n.push([o,t[r]]):n.splice(a,0,[o,t[r]])}return n.map((t=>t[1]))}function n(t,e,s=1,n=!1){const i=s<0;let[r,o]=null==e?[0,t]:[t,e];const a=r<o;s=s?a!==i?s:-s:a?1:-1;const l=[];if(n)for(;a?r<=o:r>=o;)l.push(r),r+=s;else for(;a?r<o:r>o;)l.push(r),r+=s;return i&&l.reverse(),l}function i(t,e,s=-1){if(t===e)return!0;if(t&&s&&'object'==typeof t){if(!e||'object'!=typeof e)return!1;const n=t.constructor;if(n!==e.constructor)return!1;s--;let r=!1;switch(n){case Object:break;case Array:r=!0;break;case Set:r=!0,t=[...t],e=[...e];break;case Map:if(t.size!==e.size)return!1;for(const[n,r]of t){if(!e.has(n))return!1;if(s?!i(e.get(n),r,s):e.get(n)!==r)return!1}return!0;default:const n=t.toString();'[object NodeList]'!==n&&'[object HTMLCollection]'!==n||(r=!0)}if(r){const n=t.length;if(n!==e.length)return!1;for(let r=0;r<n;r++)if(s?!i(t[r],e[r],s):t[r]!==e[r])return!1}else{for(const n in e){if(!t.hasOwnProperty(n))return!1;if(s?!i(t[n],e[n],s):t[n]!==e[n])return!1}for(const s in t)if(!e.hasOwnProperty(s))return!1}return!0}return!1}function r(t,e=-1){if(!t||!e||'object'!=typeof t)return t;e--;let s=null;switch(t.constructor){case Object:break;case Array:s=t;break;case Set:return new Set(e?[...t].map((t=>r(t,e))):t);case Map:return new Map(e?[...t].map((([t,s])=>[r(t,e),r(s,e)])):t);default:const n=t.toString();'[object NodeList]'!==n&&'[object HTMLCollection]'!==n||(s=[...t])}if(s)return e?s.map((t=>r(t,e))):[...s];if(!e)return Object.assign({},t);const n=new t.constructor;for(const s in t)n[s]=r(t[s],e);return n}var o,a;function l(t,e,s=1){const n='string'==typeof s?o[s]:s;let r;return(s,o=!1,a)=>{const l=e;if(n<-1){if(-2!==n)return!1}else if(!o&&i(l,s,n))return!1;return void 0!==a&&(r&&r(l,s),r=void 0,t=a||void 0),e=s,t&&(r=t(s,l)||void 0),!1}}function c(t,e=0){let s,n;const r='string'==typeof e?o[e]:e;return(...e)=>{if(n)if(r<-1){if(-2!==r)return s}else if(i(n,e,r>=0?r+1:r))return s;return n=e,s=t(...e),s}}function h(t,e,s=0){let n,r;const a='string'==typeof s?o[s]:s;return(...s)=>{const o=t(...s);if(n)if(a<-1){if(-2!==a)return r}else if(i(o,n,a))return r;return n=o,r=e(...n),r}}function u(t,e,s,n=0){const i={};return(...r)=>{const o=s(...r,i);return i[o]||(i[o]=h(t,e,n)),i[o](...r)}}function d(t,e){for(const s of t.slice()){const n=s[2]||0;if(n&a.OneShot){const e=s[4]||t,n=e.indexOf(s);-1!==n&&e.splice(n,1)}n&a.Deferred?setTimeout((()=>s[0](...s[1]&&e?[...e,...s[1]]:e||s[1]||[])),0):s[0](...s[1]&&e?[...e,...s[1]]:e||s[1]||[])}}(t=>{t[t.never=-3]='never',t[t.always=-2]='always',t[t.deep=-1]='deep',t[t.changed=0]='changed',t[t.shallow=1]='shallow',t[t.double=2]='double'})(o||(o={})),(t=>{t[t.OneShot=1]='OneShot',t[t.Deferred=2]='Deferred',t[t.None=0]='None',t[t.All=3]='All'})(a||(a={}));class f extends(g(Object)){}function g(t){return class extends t{constructor(){super(...arguments),this.signals={}}listenTo(t,e,s,n=a.None,i){var r,o;let l=this.signals[t];const c=[e,s||null,n||a.None,null!=i?i:null];l?l.some(((t,s)=>t[0]===e&&(l[s]=c)))||l.push(c):this.signals[t]=l=[c],c[2]&a.OneShot&&c.push(l),null===(o=(r=this.constructor).onListener)||void 0===o||o.call(r,this,t,l.indexOf(c),!0)}unlistenTo(t,e,s){var n,i;null==t?t=Object.keys(this.signals):'string'==typeof t&&(t=[t]);const r=null!=s;for(const o of t){const t=this.signals[o];if(t){for(let a=t.length-1;a>=0;a--)e&&t[a][0]!==e||r&&t[a][3]!==s||(null===(i=(n=this.constructor).onListener)||void 0===i||i.call(n,this,o,a,!1),t.splice(a,1));t[0]||delete this.signals[o]}}}isListening(t,e,s){return null==t?Object.keys(this.signals).some((t=>this.isListening(t,e,s))):!!this.signals[t]&&(!(e&&!this.signals[t].some((t=>t[0]===e)))&&!(null!=s&&!this.signals[t].some((t=>t[3]===s))))}sendSignal(t,...e){const s=this.constructor.getListenersFor?this.constructor.getListenersFor(this,t):this.signals[t];s&&d(s,e)}static onListener(t,e,s,n){}}}function y(t,e,s){const n=s&&(s.includes('first')||s.includes('first-true')),i=s&&(n||s.includes('last')),r=s&&s.includes('no-false'),o=s&&s.includes('no-null');let l=[];for(const c of t.slice()){const h=c[2]||0;if(h&a.OneShot){const e=c[4]||t,s=e.indexOf(c);-1!==s&&e.splice(s,1)}if(h&a.Deferred)setTimeout((()=>c[0](...c[1]&&e?[...e,...c[1]]:e||c[1]||[])),0);else{const t=c[0](...c[1]&&e?[...e,...c[1]]:e||c[1]||[]);if(!t&&(void 0===t||r||o&&null==t))continue;if(i?l[0]=t:l.push(t),n&&(t||!s.includes('first-true')))break}}return i?l[0]:l}class p extends(v(Object)){}function v(t){return class extends(g(t)){sendSignalAs(t,e,...s){const n='string'==typeof t?[t]:t,i=n.includes('delay')||n.includes('pre-delay'),r=n.includes('first')||n.includes('first-true'),o=n.includes('multi')||!r&&!n.includes('last');if(n.includes('await'))return new Promise((async t=>{i&&await this.afterRefresh(n.includes('delay'));const a=this.constructor.getListenersFor?this.constructor.getListenersFor(this,e):this.signals[e];if(!a)return t(o?[]:void 0);let l=(await Promise.all(y(a,s))).filter((t=>!(void 0===t||null==t&&n.includes('no-null')||!t&&n.includes('no-false'))));r&&n.includes('first-true')&&(l=l.filter((t=>t)));const c=l.length;c?r?t(o?[l[0]]:l[0]):n.includes('last')?t(o?[l[c-1]]:l[c-1]):t(l):t(o?[]:void 0)}));if(!i){const t=this.constructor.getListenersFor?this.constructor.getListenersFor(this,e):this.signals[e];return t?y(t,s,n):n.includes('last')||r?void 0:[]}(async()=>{await this.afterRefresh(n.includes('delay'));const t=this.constructor.getListenersFor?this.constructor.getListenersFor(this,e):this.signals[e];t&&(r?y(t,s,n):d(t,s))})()}afterRefresh(t=!1){return new Promise((e=>setTimeout(t&&this.awaitDelay?async()=>{await this.awaitDelay(),e()}:e,0)))}}}class x extends(D(Object)){}function D(t){return class extends t{constructor(){super(...arguments),this.dataListeners=new Map}listenToData(...t){var e;let s=1;const n=t.length,i='boolean'==typeof t[n-s]&&t[n-s++],r='object'==typeof t[0],o=r?t[0]:Array.isArray(t[n-s])?null===(e=t[n-s++])||void 0===e?void 0:e.slice():void 0,a=r?Object.keys(t[0]):t.slice(0,n-s),l=t[n-s];this.dataListeners.set(l,[o,...a]),i&&l(...this.getDataArgsBy(a,o))}unlistenToData(t){return!!this.dataListeners.has(t)&&(this.dataListeners.delete(t),!0)}getInData(t,e=void 0){}setInData(t,e,s,n){}getDataArgsBy(t,e){return e?Array.isArray(e)?t.map(((t,s)=>this.getInData(t,e[s]))):[t.reduce(((t,s)=>(t[s]=this.getInData(s,e[s]),t)),{})]:t.map(((t,e)=>this.getInData(t)))}callDataBy(t=!0,e){if(e||!this.constructor.callDataListenersFor)for(const[e,[s,...n]]of this.dataListeners.entries())(!0===t||t.some((t=>n.some((e=>e===t||e.startsWith(t+'.')||t.startsWith(e+'.'))))))&&e(...this.getDataArgsBy(n,s));else this.constructor.callDataListenersFor(this,t)}}}class m extends(w(Object)){}function w(t){return class extends(D(t)){constructor(...t){super(...t.slice(1)),this.dataListeners=new Map,this.dataKeysPending=null,this.data=t[0]||{}}getData(){return this.data}getInData(t,e){if(!this.data)return e;if(!t)return this.data;const s=t.split('.');let n=this.data;for(const t of s){if(!n)return e;n=n[t]}return void 0===n?e:n}setData(t,e=!0,s=!0,n){this.data=!1!==e?Object.assign(Object.assign({},this.data),t):t,s?this.refreshData(!0,n):this.addRefreshKeys(!0)}setInData(t,e,s=!0,n=!0,i){var r,o;if(t){const n=t.split('.'),i=n.pop();if(!i)return;let a=this.data=Object.assign({},this.data);for(const t of n)a=a[t]=(null===(r=a[t])||void 0===r?void 0:r.constructor)===Object?Object.assign({},a[t]):a[t]||{};a[i]=s&&(null===(o=a[i])||void 0===o?void 0:o.constructor)===Object?Object.assign(Object.assign({},a[i]),e):e}else this.data=s&&this.data?Object.assign(Object.assign({},this.data),e):e;n?this.refreshData(t||!0,i):this.addRefreshKeys(t||!0)}refreshData(t,e){if(t&&this.addRefreshKeys(t),null!=e)return void setTimeout((()=>this.refreshData(null)),e);const s=this.dataKeysPending;this.dataKeysPending=null,s&&this.callDataBy(s)}addRefreshKeys(t){if(!0===t)this.dataKeysPending=!0;else if(t&&!0!==this.dataKeysPending)if('string'==typeof t&&(t=[t]),this.dataKeysPending)for(const e of t)this.dataKeysPending.some((t=>t===e||e.startsWith(t+'.')))||this.dataKeysPending.push(e);else this.dataKeysPending=[...t]}}}class b extends f{constructor(...t){super(),this.promise=Promise.resolve(),this.state='',this.pendingInitializer=t[0],this.pending=this.pendingInitializer?this.pendingInitializer():void 0}trigger(t,e){return this.state?void 0!==e&&this.extend(e):(this.state='waiting',this.promise=new Promise((t=>this._resolvePromise=()=>{delete this._resolvePromise,t()})),this.extend(void 0===e?t:e),this.sendSignal('onStart')),this.promise}extend(t,e=!0){'resolving'!==this.state&&(this.clearTimer(),null===t?this.resolve():this.state?void 0!==t&&(this.timer=setTimeout((()=>{delete this.timer,this.resolve()}),t)):e&&this.trigger(t))}clearTimer(){void 0!==this.timer&&(clearTimeout(this.timer),delete this.timer)}resetPending(){const t=this.pending;return this.pending=this.pendingInitializer?this.pendingInitializer():void 0,t}resolve(){if('waiting'!==this.state)return;this.state='resolving',this.clearTimer();const t=this.resetPending();this.sendSignal('onResolve');let e=0;const s=(t=!1)=>{var s;1&e?t||2&e||'resolving'!==this.state||(e|=2,this.state=''):(e|=t?1:3,t||(this.state=''),null===(s=this._resolvePromise)||void 0===s||s.call(this))};this.sendSignal('onRefresh',t,s),s(),this.sendSignal('onFinish',!1)}reject(){var t;'waiting'===this.state&&(this.state='resolving',this.clearTimer(),this.resetPending(),this.sendSignal('onResolve'),this.state='',null===(t=this._resolvePromise)||void 0===t||t.call(this),this.sendSignal('onFinish',!0))}}class O extends(w(v(Object))){constructor(t,e){super(t),this.settings=this.constructor.getDefaultSettings(),this.contextAPIs=new Map,this.preDelayCycle=new b,this.delayCycle=new b,e&&this.modifySettings(e),this.constructor.initializeCyclesFor(this)}modifySettings(t){var e;const s=this.constructor.getDefaultSettings();for(const n in t)this.settings[n]=void 0!==t[n]?t[n]:null!==(e=this.settings[n])&&void 0!==e?e:s[n]}triggerRefresh(t){this.preDelayCycle.trigger(this.settings.refreshTimeout,t)}afterRefresh(t=!1,e){return t?this.delayCycle.trigger(void 0,e):this.preDelayCycle.trigger(this.settings.refreshTimeout,e)}async awaitDelay(){const t=new Set;for(const e of this.contextAPIs.keys())t.add(e.afterRefresh(!0));await Promise.all(t)}refreshData(t,e){t&&this.addRefreshKeys(t),this.triggerRefresh(e)}static getListenersFor(t,e){let s=t.signals[e]||[];for(const[n,i]of t.contextAPIs)for(const t of i){const i=n.constructor.getListenersFor?n.constructor.getListenersFor(n,t+'.'+e):n.signals[t+'.'+e];i&&(s=s.concat(i))}return s[0]&&s}static getDefaultSettings(){return{refreshTimeout:0}}static initializeCyclesFor(t){t.preDelayCycle.listenTo('onRefresh',((e,s)=>t.constructor.runPreDelayFor(t,s))),t.delayCycle.listenTo('onRefresh',((e,s)=>t.constructor.runDelayFor(t,s))),t.preDelayCycle.listenTo('onFinish',(()=>{t.delayCycle.trigger(),'waiting'===t.delayCycle.state&&(t.awaitDelay?t.awaitDelay().then((()=>t.delayCycle.resolve())):t.delayCycle.resolve())})),t.delayCycle.listenTo('onStart',(()=>t.preDelayCycle.trigger())),t.delayCycle.listenTo('onResolve',(()=>t.preDelayCycle.resolve()))}static runPreDelayFor(t,e){const s=t.dataKeysPending;if(t.dataKeysPending=null,e(),s){for(const[e,[n,...i]]of t.dataListeners.entries())(!0===s||s.some((t=>i.some((e=>e===t||e.startsWith(t+'.')||t.startsWith(e+'.'))))))&&e(...t.getDataArgsBy(i,n));for(const[e,n]of t.contextAPIs.entries())e.callDataBy(!0===s?n:n.reduce(((t,e)=>t.concat(s.map((t=>t?e+'.'+t:e)))),[]))}}static runDelayFor(t,e){}}class C extends(D(v(Object))){constructor(t){super(),this.contexts=Object.assign({},t),this.dataListeners=new Map}afterRefresh(t=!1,e){return this.awaitDelay?this.awaitDelay():Promise.resolve()}sendSignal(t,...e){var s;const n=t.indexOf('.');-1!==n&&(null===(s=this.getContext(t.slice(0,n)))||void 0===s||s.sendSignal(t.slice(n+1),...e))}sendSignalAs(t,e,...s){const n=e.indexOf('.'),i=-1===n?null:this.getContext(e.slice(0,n));if(i)return i.sendSignalAs(t,e.slice(n+1),...s);const r='string'==typeof t?[t]:t,o=r.includes('last')||r.includes('first')||r.includes('first-true')?void 0:[];return r.includes('await')?Promise.resolve(o):o}getInData(t,e=void 0){const s=t.indexOf('.'),n=this.getContext(-1===s?t:t.slice(0,s));return n?-1===s?n.getData():n.getInData(t.slice(s+1),e):e}setInData(t,e,s,n,i){const r=t.indexOf('.'),o=this.getContext(-1===r?t:t.slice(0,r));o&&(-1===r?o.setData(e,s,n,i):o.setInData(t.slice(r+1),e,s,n,i))}refreshData(t,e){var s,n;const i={};for(const e of'string'==typeof t?[t]:t){const t=e.indexOf('.'),n=-1===t?e:e.slice(0,t);void 0!==i[n]&&(i[n]=this.getContext(n)),null===(s=i[n])||void 0===s||s.addRefreshKeys(-1===t||e.slice(n.length+1))}for(const t in i)null===(n=i[t])||void 0===n||n.refreshData(null,e)}refreshDataBy(t,e){const s=this.getContexts(t);for(const n in s){const i=s[n];i&&i.refreshData(t[n],e)}}getContext(t){return this.contexts[t]}getContexts(t,e=!1){if(!t)return Object.assign({},this.contexts);const s=t.constructor===Set?t:t.constructor===Array?new Set(t):new Set(Object.keys(t)),n={};for(const t in this.contexts)!s.has(t)||void 0===this.contexts[t]||e&&null===this.contexts[t]||(n[t]=this.contexts[t]);return n}newContext(t,e,s=!0){const n=new O(t);return e&&this.setContext(e,n,s),n}newContexts(t,e=!1,s=!0){const n={};for(const e in t)n[e]=new O(t[e]);return e&&this.setContexts(n,s),n}setContext(t,e,s=!0){const n=this.contexts[t];if(n===e)return!1;if(n){const e=n.contextAPIs.get(this);if(e){const s=e.filter((e=>e!==t));s.length?n.contextAPIs.set(this,s):n.contextAPIs.delete(this)}}if(e){const s=e.contextAPIs.get(this)||[];s.includes(t)||s.push(t),e.contextAPIs.set(this,s)}return void 0!==e?this.contexts[t]=e:delete this.contexts[t],s&&this.callDataBy([t]),!0}setContexts(t,e=!0){let s=!1;for(const e in t)s=this.setContext(e,t[e],!1)||s;return e&&s&&this.callDataBy(Object.keys(t)),s}static parseContextDataKey(t){const e=t.indexOf('.');return-1===e?[t,'']:[t.slice(0,e),t.slice(e+1)]}static readContextNamesFrom(t){return t.reduce(((t,e)=>{const s=e.indexOf('.'),n=-1===s?e:e.slice(0,s);return n&&!t.includes(n)&&t.push(n),t}),[])}static readContextDictionaryFrom(t){const e={};for(const s of t){const[t,n]=C.parseContextDataKey(s);!0!==e[t]&&(n?(e[t]||(e[t]=[])).push(n):e[t]=!0)}return e}}export{o as CompareDataDepthEnum,O as Context,C as ContextAPI,x as DataBoy,m as DataMan,b as RefreshCycle,f as SignalBoy,a as SignalListenerFlags,p as SignalMan,i as areEqual,y as askListeners,d as callListeners,t as cleanIndex,u as createCachedSource,c as createDataMemo,h as createDataSource,l as createDataTrigger,r as deepCopy,D as mixinDataBoy,w as mixinDataMan,g as mixinSignalBoy,v as mixinSignalMan,n as numberRange,s as orderArray,e as orderedIndex};
